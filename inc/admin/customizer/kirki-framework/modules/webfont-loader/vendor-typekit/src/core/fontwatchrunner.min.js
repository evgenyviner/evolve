goog.provide("webfont.FontWatchRunner");goog.require("webfont.Font");goog.require("webfont.FontRuler");webfont.FontWatchRunner=function(b,d,f,c,a,g,e){this.activeCallback_=b;this.inactiveCallback_=d;this.domHelper_=f;this.font_=c;this.fontTestString_=e||webfont.FontWatchRunner.DEFAULT_TEST_STRING;this.lastResortWidths_={};this.timeout_=a||3000;this.metricCompatibleFonts_=g||null;this.fontRulerA_=null;this.fontRulerB_=null;this.lastResortRulerA_=null;this.lastResortRulerB_=null;this.setupRulers_()};webfont.FontWatchRunner.LastResortFonts={SERIF:"serif",SANS_SERIF:"sans-serif"};webfont.FontWatchRunner.DEFAULT_TEST_STRING="BESbswy";goog.scope(function(){var a=webfont.FontWatchRunner,c=webfont.Font,b=webfont.FontRuler;a.HAS_WEBKIT_FALLBACK_BUG=null;a.getUserAgent=function(){return window.navigator.userAgent};a.hasWebKitFallbackBug=function(){if(a.HAS_WEBKIT_FALLBACK_BUG===null){var d=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(a.getUserAgent());a.HAS_WEBKIT_FALLBACK_BUG=!!d&&(parseInt(d[1],10)<536||(parseInt(d[1],10)===536&&parseInt(d[2],10)<=11))}return a.HAS_WEBKIT_FALLBACK_BUG};a.prototype.setupRulers_=function(){this.fontRulerA_=new b(this.domHelper_,this.fontTestString_);this.fontRulerB_=new b(this.domHelper_,this.fontTestString_);this.lastResortRulerA_=new b(this.domHelper_,this.fontTestString_);this.lastResortRulerB_=new b(this.domHelper_,this.fontTestString_);this.fontRulerA_.setFont(new c(this.font_.getName()+","+a.LastResortFonts.SERIF,this.font_.getVariation()));this.fontRulerB_.setFont(new c(this.font_.getName()+","+a.LastResortFonts.SANS_SERIF,this.font_.getVariation()));this.lastResortRulerA_.setFont(new c(a.LastResortFonts.SERIF,this.font_.getVariation()));this.lastResortRulerB_.setFont(new c(a.LastResortFonts.SANS_SERIF,this.font_.getVariation()));this.fontRulerA_.insert();this.fontRulerB_.insert();this.lastResortRulerA_.insert();this.lastResortRulerB_.insert()};a.prototype.start=function(){this.lastResortWidths_[a.LastResortFonts.SERIF]=this.lastResortRulerA_.getWidth();this.lastResortWidths_[a.LastResortFonts.SANS_SERIF]=this.lastResortRulerB_.getWidth();this.started_=goog.now();this.check_()};a.prototype.widthMatches_=function(e,d){return e===this.lastResortWidths_[d]};a.prototype.widthsMatchLastResortWidths_=function(e,d){for(var f in a.LastResortFonts){if(a.LastResortFonts.hasOwnProperty(f)){if(this.widthMatches_(e,a.LastResortFonts[f])&&this.widthMatches_(d,a.LastResortFonts[f])){return true}}}return false};a.prototype.hasTimedOut_=function(){return goog.now()-this.started_>=this.timeout_};a.prototype.isFallbackFont_=function(e,d){return this.widthMatches_(e,a.LastResortFonts.SERIF)&&this.widthMatches_(d,a.LastResortFonts.SANS_SERIF)};a.prototype.isLastResortFont_=function(e,d){return a.hasWebKitFallbackBug()&&this.widthsMatchLastResortWidths_(e,d)};a.prototype.isMetricCompatibleFont_=function(){return this.metricCompatibleFonts_===null||this.metricCompatibleFonts_.hasOwnProperty(this.font_.getName())};a.prototype.check_=function(){var e=this.fontRulerA_.getWidth();var d=this.fontRulerB_.getWidth();if(this.isFallbackFont_(e,d)||this.isLastResortFont_(e,d)){if(this.hasTimedOut_()){if(this.isLastResortFont_(e,d)&&this.isMetricCompatibleFont_()){this.finish_(this.activeCallback_)}else{this.finish_(this.inactiveCallback_)}}else{this.asyncCheck_()}}else{this.finish_(this.activeCallback_)}};a.prototype.asyncCheck_=function(){setTimeout(goog.bind(function(){this.check_()},this),50)};a.prototype.finish_=function(d){setTimeout(goog.bind(function(){this.fontRulerA_.remove();this.fontRulerB_.remove();this.lastResortRulerA_.remove();this.lastResortRulerB_.remove();d(this.font_)},this),0)}});